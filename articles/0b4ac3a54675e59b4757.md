---
title: "yarn workspacesã‚’ä½¿ã£ãŸReact Nativeã®ç’°å¢ƒæ§‹ç¯‰"
emoji: "ğŸ±"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["yarn", "workspaces", "ReactNative"]
published: true
---

# ã¯ã˜ã‚ã«

React Native ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¤ã„ã¦ã®ãŠè©±ã§ã™ã€‚  
lerna ãŒç™»å ´ã—ãŸã‚ãŸã‚Šã‹ã‚‰ã€è¤‡æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ 1 ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹ãƒ¢ãƒãƒªã‚·ãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªï¼ˆä»¥ä¸‹ã€ãƒ¢ãƒãƒ¬ãƒï¼‰é‹ç”¨ã‚‚æ´»ç™ºã«ãªã£ã¦ãã¾ã—ãŸã€‚  
æ˜¨ä»Šã®é–‹ç™ºã«ãŠã„ã¦ã€ãƒ¢ãƒãƒ¬ãƒé‹ç”¨ã‚’ã™ã‚‹ã«ã¯

- lerna
- npm workspaces
- yarn workspaces
- pnpm workspace

ãŒé¸æŠè‚¢ã«ä¸ŠãŒã‚Šã¾ã™ã€‚  
ã•ã‚‰ã«ãƒ¢ãƒãƒ¬ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ hoisting ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
ã“ã®è¨˜äº‹ã§ã¯ã€yarn workspaces ã‚’ä½¿ã£ã¦ React Native ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ã„ã„ãã¾ã™ã€‚  
ãƒ¢ãƒãƒ¬ãƒé‹ç”¨ã‚„ hoisting ãŒä½•ã‹ã«ã¤ã„ã¦ã¯ã€ä»–ã®è¨˜äº‹ã®è§£èª¬ã«è­²ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ãªãŠã€yarn ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ v1 ç³»ã‚’å‰æã«ã—ã¦ã„ã¾ã™ã€‚

## React Native ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Berry ã®ä½¿ç”¨ã¯ãŠã™ã™ã‚ã—ã¾ã›ã‚“

ç­†è€…ã¯ yarn v3ï¼ˆBerryï¼‰ã§ã‚‚ç’°å¢ƒæ§‹ç¯‰ã‚’ã—ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€å®‰å®šã—ãªã„ã®ã§ã‚ã¾ã‚ŠãŠã™ã™ã‚ã¯ã—ã¾ã›ã‚“ã€‚  
yarn ios ã¾ãŸã¯ yarn android ã§ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã¨ã€node_modules ã®ä¸­èº«ãŒæ›¸ãæ›ã‚ã‚‹ã“ã¨ãŒã‚ã‚‹ã¿ãŸã„ã§ã™ã€‚

iOS ã§å‹•ä½œç¢ºèª => Android ã§å‹•ä½œç¢ºèª => Android ã®ãƒ“ãƒ«ãƒ‰ãŒã‚³ã‚±ã‚‹
Android ã§å‹•ä½œç¢ºèª => iOS ã§å‹•ä½œç¢ºèª => iOS ã®ãƒ“ãƒ«ãƒ‰ãŒã‚³ã‚±ã‚‹

é•ã†ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ«ãƒ‰ã‚’ã™ã‚‹æ™‚ã«ã€çµæ§‹ãªç¢ºç‡ã§ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã™ (åŒä¸€ OS ã ã¨ãªãœã‹ã‚³ã‚±ãªã„)ã€‚  
`yarn`ã—ãªãŠã—ã¦ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ›´æ–°ã™ã‚‹ã¨ã€æ­£å¸¸ã«èµ·å‹•ã™ã‚‹ã‚ˆã†ã«ã¯ãªã‚Šã¾ã™ã€‚  
å˜ç´”ã«é¢å€’ã ã—ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ãƒ“ãƒ«ãƒ‰ãŒã‚³ã‚±ã‚‹ã“ã¨ã»ã©æ€–ã„ã“ã¨ãŒãªã„ã®ã§ã€ç²¾ç¥è¡›ç”Ÿçš„ã«ã‚‚æ‚ªã„ã§ã™ã€‚

ãƒ¢ãƒãƒ¬ãƒã ã‹ã‚‰èµ·ã“ã‚‹ã®ã‹ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€ã“ã†ã„ã†ç¾è±¡ã‚’ç¢ºèªã—ã¦ã‚‹ã®ã§ä½¿ç”¨ã¯ãŠã™ã™ã‚ã—ã¾ã›ã‚“ã€‚  
yarn v1 ã ã¨ä¸Šè¨˜ã®ã‚ˆã†ãªç¾è±¡ã¯èµ·ããªã‹ã£ãŸã§ã™ã€‚

## yarn workspaces ã¨ React Native ã®å•é¡Œ

yarn workspaces ã¯ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãƒ«ãƒ¼ãƒˆã® node_modules ã« hoisting ã•ã‚Œã‚‹ã¨ã„ã†æ€§è³ªãŒã€React Native ã§ã¯è‰²ã€…ã¨å•é¡Œã‚’èµ·ã“ã—ã¾ã™ã€‚  
å®Ÿéš›ã«ç’°å¢ƒæ§‹ç¯‰ã‚’ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€React Native æœ¬ä½“ã‚„ Metro ã¯å‹¿è«–ã®ã“ã¨ã€CocoaPods ã‚„ Xcode ãªã©ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¾ã™ã€‚  
ãªã‚“ãªã‚‰ã€react-native-cli ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆã‹ã‚‰ã„ããªã‚Šã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦å¤±æ•—ã—ã¾ã™ã€‚

ã“ã‚Œã¯ã€react-native-cli ãŒç”Ÿæˆã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã‚’åŸºæº–ã«ä½œæˆã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚  
ã¾ãŸã€React Native ã«é–¢ã‚ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«éƒ¡ã‚‚ã€åŸºæœ¬çš„ã«åŒä¸€éšå±¤ã® node_modules ã«å…¨ã¦ã„ã‚‹å‰æã§å‹•ãã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚  
yarn workspaces ç’°å¢ƒä¸‹ã§ react-native-cli ã‚’å®Ÿè¡Œã—ãŸå ´åˆã‚‚ã€ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ hoisting ã•ã‚Œã¾ã™ã€‚
ã¤ã¾ã‚Šã€ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å…¨ã¦ãƒ«ãƒ¼ãƒˆã® node_modules ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ï¼ˆä¾‹å¤–ã‚ã‚Šï¼‰ã€‚  
ãã®ãŸã‚ã€node_modules ã®å‚ç…§å…ˆãŒåˆã‚ãšã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚‹ã¨ã„ã†ã‚«ãƒ©ã‚¯ãƒªã§ã™ã€‚

ãªãŠã€npm workspaces ã‚’ä½¿ã£ã¦ã‚‚ã“ã®ç¾è±¡ã¯èµ·ãã¾ã™ã€‚

### ãŸã¾ãŸã¾ã†ã¾ãã„ãå ´åˆã‚‚ã‚ã‚‹

ã“ã®å•é¡Œã‚’æ›´ã«ã‚„ã‚„ã“ã—ãã™ã‚‹ã®ãŒã€å¿…ãšã—ã‚‚ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚‹ã‚ã‘ã§ã¯ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚  
å…ˆã»ã©ã€ä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å…¨ã¦ãƒ«ãƒ¼ãƒˆã® node_modules ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã¨æ›¸ãã¾ã—ãŸã€‚  
æ—¢ã«ãƒ¢ãƒãƒ¬ãƒé‹ç”¨ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆæ¸ˆã¿ã®å ´åˆã€ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ä¾å­˜è§£æ±ºã®å…¼ã­åˆã„ã«ã‚ˆã£ã¦ã¯ã€packages é…ä¸‹ã® node_modules ã« React Native ã‚„ Metro ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãŒèµ·ããšã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆãŒã§ãã¾ã™ã€‚  
ãŸã ã—ã€ã“ã‚Œã§ã¯ hoisting ã®æ©æµã«ã‚ã‚„ã‹ã‚Œãªããªã‚‹ã®ã§æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚  
é–‹ç™ºã‚’é€²ã‚ã¦ã„ãä¸­ã§ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ãŸã‚Šã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ãŸã‚Šã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ hoisting ã•ã‚Œã‚‹ã¨å‹•ã‹ãªããªã‚‹ã®ã§ã€å±ãªã„ã§ã™ã€‚

# ã‚¤ãƒã‹ã‚‰ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹

ãã‚Œã§ã¯ã€ã¾ã£ã•ã‚‰ãªç’°å¢ƒã‹ã‚‰ yarn workspaces ã‚’ä½¿ã£ãŸãƒ¢ãƒãƒ¬ãƒé‹ç”¨ã§ç’°å¢ƒæ§‹ç¯‰ã‚’ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚  
ä»Šå›ã€React ã‚’ä½¿ã£ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã¨ React Native ã‚’ä½¿ã£ãŸãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚’ 1 ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚  
ã¾ãŸã€å…±é€šã®é–¢æ•°ã‚„å®šæ•°ãªã©ã‚’ç®¡ç†ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ä½œã£ã¦èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚  
ã“ã‚“ãªæ„Ÿã˜ã®ãƒ¢ãƒãƒ¬ãƒã§ã™ã­ã€‚  
ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã¯ã€package.json ã® name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨˜è¼‰ã™ã‚‹åå‰ã®ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚

| ãƒ•ã‚©ãƒ«ãƒ€å | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å      | èª¬æ˜                                 |
| :--------- | :---------------- | :----------------------------------- |
| web        | @monorepo/web     | React ã‚’ä½¿ã£ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒª           |
| mobile     | @monorepo/mobile  | React Native ã‚’ä½¿ã£ãŸãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª  |
| modules    | @monorepo/modules | web ã¨ mobile ã§ä½¿ã†å…±é€šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« |

# ãƒ«ãƒ¼ãƒˆã® pakcage.json ã®ä½œæˆ

ãƒ¢ãƒãƒ¬ãƒé‹ç”¨ã™ã‚‹é©å½“ãªãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã€ç„¡é‚ªæ°—ã« npm init ã‚’å®Ÿè¡Œã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

```
npm init
```

package.json ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚

```json:package.json
{
  "name": "monorepo",
  "version": "0.0.1",
  "license": "ISC",
  "description": "",
  "private": true,
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "workspaces": ["packages/*"],
  "devDependencies": {
    "@typescript-eslint/eslint-plugin": "^5.51.0",
    "@typescript-eslint/parser": "^5.51.0",
    "eslint": "^8.34.0",
    "eslint-config-prettier": "^8.6.0",
    "eslint-plugin-import": "^2.27.5",
    "eslint-plugin-react": "^7.32.2",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-native": "^4.0.0",
    "jest": "^29.4.2",
    "prettier": "^2.8.4",
    "typescript": "^4.9.5"
  }
}
```

ESLint ã‚„ TypeScript ã¯å…±é€šã§åˆ©ç”¨ã™ã‚‹ã®ã§ã€ãƒ«ãƒ¼ãƒˆã® package.json ã«è¿½åŠ ã—ã¾ã™ã€‚  
yarn workspaces ã¯ package.json å†…ã« workspaces ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«é…åˆ—ã§è¨˜è¿°ã—ã¾ã™ã€‚

```json
"workspaces": [
  "packages/*"
],
```

`packages/*`ã¨æ›¸ãã“ã¨ã§ã€packages ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ãŒ workspaces ã®å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚  
TypeScript ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ tsconfig.json ã‚‚ä½œæˆã—ã¾ã™ã€‚  
è¨­å®šã¯ãŠå¥½ã¿ã§ã€‚

```json:tsconfig.json
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "commonjs",
    "lib": ["ES2020"],
    "jsx": "react",
    "strict": true,
    "esModuleInterop": true
  }
}
```

ãƒ«ãƒ¼ãƒˆã®è¨­å®šã¯ä¸€æ—¦å®Œäº†ã§ã™ã€‚

## web ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆ

React ã‚’ä½¿ã£ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚  
ã“ã®è¨˜äº‹ã§ã¯ã‚ã¾ã‚Šé–¢ä¿‚ãªã„ã®ã§ã€Next.js ã§ã‚µã‚¯ãƒƒã¨ç’°å¢ƒæ§‹ç¯‰ã—ã¡ã‚ƒã„ã¾ã—ã‚‡ã†ã€‚  
`yarn create next-app --typescript`ã‚’å©ãã¨ã€ã„ãã¤ã‹è³ªå•ã•ã‚Œã‚‹ã®ã§ã€ç­”ãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚  
ã“ã“ã§ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’`web`ã¨ç­”ãˆã¦ã€ä»–ã¯å…¨ã¦ Yes ã¨ç­”ãˆã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚  
ä½œæˆã•ã‚ŒãŸã‚‰ã€package.json ã® name ã‚’`@monorepo/web`ã«ãƒªãƒãƒ¼ãƒ ã™ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

```
mkdir packages
cd ./packages
yarn create next-app --typescript

âœ” What is your project named? â€¦ web
âœ” Would you like to use TypeScript with this project? â€¦ No / Yes
âœ” Would you like to use ESLint with this project? â€¦ No / Yes
âœ” Would you like to use `src/` directory with this project? â€¦ No / Yes
âœ” Would you like to use experimental `app/` directory with this project? â€¦ No / Yes
âœ” What import alias would you like configured? â€¦ @/*
```

:::message
ã“ã®è¨˜äº‹ã§ã¯è©³ã—ãã¯è§¦ã‚Œã¾ã›ã‚“ãŒã€ãƒ¢ãƒãƒ¬ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ Next.js ã‚’ä½¿ã†å ´åˆã¯ã€next.config.js ã§ experimental.externalDir ã‚’ true ã«è¨­å®šã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚  
ã“ã®è¨­å®šã‚’ã—ã¦ãŠã‹ãªã„ã¨ã€é•ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ import ã—ãŸæ™‚ã«è§£æã§ããšã«ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã™ã€‚
:::

## mobile ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆ

ã•ã¦ã€ã“ã“ã‹ã‚‰ãŒæœ¬é¡Œã§ã™ã€‚  
react-native-cli ã‚’ä½¿ã£ã¦ React Native ã®ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚  
ç’°å¢ƒæ§‹ç¯‰ã¯[React Native Setting up the development environment](https://reactnative.dev/docs/environment-setup)ã‚’ãƒ™ãƒ¼ã‚¹ã«è¡Œã„ã¾ã™ã€‚  
ã“ã“ã§ã¯ Xcode ã‚„ Android Studio ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯çµ‚ã‚ã£ã¦ã‚‹ã‚‚ã®ã¨ã—ã¦è©±ã‚’é€²ã‚ã¾ã™ã€‚  
å…ˆãšã¯ packages ã«ç§»å‹•ã—ã¦ cli ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚  
React Native ã¯ 0.71.0 ã‹ã‚‰ TypeScript ã‚’ first class support ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

```
cd packages
npx react-native init mobile --version 0.71.0
```

ã“ã‚Œã§ packages ç›´ä¸‹ã« mobile ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹ç¯‰ãŒå§‹ã¾ã‚Šã¾ã™ã€‚  
ãŠãã‚‰ãã€CocoaPods ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§æ—©é€Ÿä¸‹è¨˜ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

```
âœ” Downloading template
âœ” Copying template
âœ” Processing template
âœ– Installing CocoaPods dependencies (this may take a few minutes)
âœ– Installing CocoaPods dependencies (this may take a few minutes)
error Error: Failed to install CocoaPods dependencies for iOS project, which is required by this template.
Please try again manually: "cd ./mobile/ios && pod install".
CocoaPods documentation: https://cocoapods.org/
```

hoisting ãŒæ­£ã—ãè¡Œã‚ã‚Œã¦ã„ãŸå ´åˆã¯ã€react-native-cli ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸä¾å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ãƒ«ãƒ¼ãƒˆã® node_modules ã«å…¥ã£ã¦ã„ã¾ã™ã€‚  
ãã®ãŸã‚ã€CocoaPods ãŒå‚ç…§ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ mobile ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã® node_modules ã«ã¯ä½•ã‚‚ãªã„ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚  
ãã‚Œã§ã¯ã€iOS ã¨ Android ã‚’ãã‚Œãã‚Œãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## iOS ã®è¨­å®š

ã¾ãšã¯ iOS ã®ãƒ“ãƒ«ãƒ‰ãŒå‹•ãã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚  
ä¿®æ­£ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹è¨˜ã® 2 ã¤ã§ã™ã€‚

- ios/Podfile
- ios/mobile.xcodeproj/project.pbxproj

### Podfile ã®ä¿®æ­£

ã¾ãšã¯ã€å…ˆã»ã©è½ã¡ãŸ pod install ãŒå‹•ãã‚ˆã†ã«ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç”Ÿæˆã—ãŸ Podfile ã¯ã€react-native ã¨@react-native-community ã®å‚ç…§å…ˆãŒ mobile ç›´ä¸‹ã® node_modules ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚  
ã“ã‚Œã‚’ãƒ«ãƒ¼ãƒˆã® node_modules ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚  
ã¾ãŸã€react_native_post_install ã®ç¬¬ 2 å¼•æ•°ã§å®Ÿè¡Œæ™‚ãƒ‘ã‚¹ã‚’å¤‰æ›´ã—ã¾ã™ã€‚  
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒä½œæˆã—ãŸã‚‚ã®ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§çœç•¥ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒ`../node_modules/react-native`ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚

```diff:packages/mobile/ios/Podfile
- require_relative '../node_modules/react-native/scripts/react_native_pods'
- require_relative '../node_modules/@react-native-community/cli-platform-ios/native_modules'
+ require_relative '../../../node_modules/react-native/scripts/react_native_pods'
+ require_relative '../../../node_modules/@react-native-community/cli-platform-ios/native_modules'

platform :ios, min_ios_version_supported
prepare_react_native_project!

flipper_config = ENV['NO_FLIPPER'] == "1" ? FlipperConfiguration.disabled : FlipperConfiguration.enabled

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
end

target 'mobile' do
  config = use_native_modules!

  # Flags change depending on the env values.
  flags = get_default_flags()

  use_react_native!(
    :path => config[:reactNativePath],
    # Hermes is now enabled by default. Disable by setting this flag to false.
    # Upcoming versions of React Native may rely on get_default_flags(), but
    # we make it explicit here to aid in the React Native upgrade process.
    :hermes_enabled => flags[:hermes_enabled],
    :fabric_enabled => flags[:fabric_enabled],
    # Enables Flipper.
    #
    # Note that if you have use_frameworks! enabled, Flipper will not work and
    # you should disable the next line.
    :flipper_configuration => flipper_config,
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/.."
  )

  target 'mobileTests' do
    inherit! :complete
    # Pods for testing
  end

  post_install do |installer|
    react_native_post_install(
      installer,
+      "../../../node_modules/react-native",
      # Set `mac_catalyst_enabled` to `true` in order to apply patches
      # necessary for Mac Catalyst builds
      :mac_catalyst_enabled => false
    )
    __apply_Xcode_12_5_M1_post_install_workaround(installer)
  end
end
```

ã“ã‚Œã§å†åº¦ pod install ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å•é¡Œãªãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã™ï¼ˆ10 åˆ†ä»¥ä¸Šã‹ã‹ã‚Šã¾ã™ï¼‰ã€‚  
ã‚‚ã—ã€Podfile.lock ã‚„ Pods ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¦ã„ãŸå ´åˆã¯ã€å¿µã®ç‚ºå‰Šé™¤ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

### XCode ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£

ç¶šã„ã¦ XCode ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ project.pbxproj ã‚’ä¿®æ­£ã—ã¾ã™ã€‚  
mobile ã¨ã„ã†åå‰ã§ä½œæˆã—ã¦ã„ã‚‹å ´åˆã€`ios/mobile.xcodeproj/project.pbxproj`ã¨ãªã£ã¦ã„ã¾ã™ã€‚  
project.pbxproj ã¯äººé–“ãŒèª­ã‚ã‚‹ã‚‚ã®ã§ã¯ãªã„ãŸã‚ã€ä¸­ã«æ›¸ã‹ã‚Œã¦ã‚ã‚‹ã‚‚ã®ã¯ç†è§£ã§ããªãã¦å¤§ä¸ˆå¤«ã§ã™ã€‚  
ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ node_modules ã§æ¤œç´¢ã™ã‚‹ã¨ 4 ä»¶ãƒ’ãƒƒãƒˆã—ã¾ã™ã€‚  
ã“ã¡ã‚‰ã‚‚å‚ç…§å…ˆãŒ mobile ç›´ä¸‹ã® node_modules ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€å…¨ã¦`../../`ã‚’è¶³ã—ã¦ãƒ«ãƒ¼ãƒˆã® node_modules ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

ä»¥ä¸Šã§ iOS ã®è¨­å®šã¯å®Œäº†ã§ã™ã€‚  
mobile ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¸­ã§ yarn ios ã‚’å©ã„ã¦èµ·å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## Android ã®è¨­å®š

ç¶šã„ã¦ Android ã‚’å‹•ãã‚ˆã†ã«ä¿®æ­£ã—ã¦ã„ãã¾ã™ã€‚  
åŸºæœ¬çš„ã«ã‚„ã‚‹ã“ã¨ã¯ iOS ã¨åŒã˜ã§ã€node_modules ã®å‚ç…§å…ˆã‚’ãƒ«ãƒ¼ãƒˆã«å¤‰ãˆã‚‹ã ã‘ã§ã™ã€‚  
ä¿®æ­£ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã® 2 ã¤ã§ã™ã€‚

- android/settings.gradle
- android/app/build.gradle

### settings.gradle ã®ä¿®æ­£

node_modules ã®å‚ç…§å…ˆã‚’ãƒ«ãƒ¼ãƒˆã«å¤‰æ›´ã—ã¾ã™ã€‚

```diff:packages/mobile/android/settings.gradle
rootProject.name = 'mobile'
- apply from: file("../node_modules/@react-native-community/cli-platform-android/native_modules.gradle");
+ apply from: file("../../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle");
applyNativeModulesSettingsGradle(settings)
include ':app'
- includeBuild('../node_modules/react-native-gradle-plugin')
+ includeBuild('../../../node_modules/react-native-gradle-plugin')
```

### android/app/build.gradle ã‚’ä¿®æ­£ã™ã‚‹

ç¶šã„ã¦ã€app ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã® build.gradle ã‚’ä¿®æ­£ã—ã¾ã™ã€‚  
android ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã«ã‚‚ build.gradle ãŒã„ã¾ã™ãŒã€ãã¡ã‚‰ã§ã¯ãªã„ã®ã§æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚

ã“ã¡ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€2 ç®‡æ‰€ä¿®æ­£ã‚’ã—ã¾ã™ã€‚  
ã¾ãšã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã® 10 è¡Œç›®ã‚ãŸã‚Šã«ã„ã‚‹ react ã¨ã„ã† JavaScript ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã£ã½ã„ä¸­èº«ã® root ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’æ¶ˆã—ã¦ã€ãƒ«ãƒ¼ãƒˆã® node_modules ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚  
ã“ã® react ã®ä¸­ã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚‹é€šã‚Šã€gradle ã« React Native ã®å„ç¨®è¨­å®šã‚’æ¸¡ã™ç®‡æ‰€ã«ãªã‚Šã¾ã™ã€‚  
åŸºæœ¬çš„ã«å¤‰æ›´ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ¢ãƒãƒ¬ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ‘ã‚¹å‚ç…§ãŒåˆã‚ãªã„ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã€ã ã„ãŸã„ã“ã“ã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```diff:packages/mobile/android/app/build.gradle
/**
 * This is the configuration block to customize your React Native Android app.
 * By default you don't need to apply any configuration, just uncomment the lines you need.
 */
react {
    /* Folders */
    //   The root of your project, i.e. where "package.json" lives. Default is '..'
-    // root = file("../")
+    root = file("../../../../")
    //   The folder where the react-native NPM package is. Default is ../node_modules/react-native
    // reactNativeDir = file("../node-modules/react-native")
    //   The folder where the react-native Codegen package is. Default is ../node_modules/react-native-codegen
    // codegenDir = file("../node-modules/react-native-codegen")
    //   The cli.js file which is the React Native CLI entrypoint. Default is ../node_modules/react-native/cli.js
    // cliFile = file("../node_modules/react-native/cli.js")

    /* Variants */
    //   The list of variants to that are debuggable. For those we're going to
    //   skip the bundling of the JS bundle and the assets. By default is just 'debug'.
    //   If you add flavors like lite, prod, etc. you'll have to list your debuggableVariants.
    // debuggableVariants = ["liteDebug", "prodDebug"]

    /* Bundling */
    //   A list containing the node command and its flags. Default is just 'node'.
    // nodeExecutableAndArgs = ["node"]
    //
    //   The command to run when bundling. By default is 'bundle'
    // bundleCommand = "ram-bundle"
    //
    //   The path to the CLI configuration file. Default is empty.
    // bundleConfig = file(../rn-cli.config.js)
    //
    //   The name of the generated asset file containing your JS bundle
    // bundleAssetName = "MyApplication.android.bundle"
    //
    //   The entry file for bundle generation. Default is 'index.android.js' or 'index.js'
    // entryFile = file("../js/MyApplication.android.js")
    //
    //   A list of extra flags to pass to the 'bundle' commands.
    //   See https://github.com/react-native-community/cli/blob/main/docs/commands.md#bundle
    // extraPackagerArgs = []

    /* Hermes Commands */
    //   The hermes compiler command to run. By default it is 'hermesc'
    // hermesCommand = "$rootDir/my-custom-hermesc/bin/hermesc"
    //
    //   The list of flags to pass to the Hermes compiler. By default is "-O", "-output-source-map"
    // hermesFlags = ["-O", "-output-source-map"]
}
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã¾ã å¤‰æ›´ã™ã‚‹ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚  
ãƒ•ã‚¡ã‚¤ãƒ«ã® 1 ç•ªä¸‹ã« node_modules ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff:packages/mobile/android/app/build.gradle
- apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
+ apply from: file("../../../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
```

ä»¥ä¸Šã§ iOS ã¨ Android ãŒãƒ“ãƒ«ãƒ‰ã§ãã‚‹ç’°å¢ƒãŒæ•´ã„ã¾ã—ãŸã€‚

## metro ã®è¨­å®š

æœ€å¾Œã« metro ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¨­å®šã‚’ä¿®æ­£ã—ã¾ã™ã€‚  
metro ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ React Nativeï¼ˆtsx ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ iOS, Android ãã‚Œãã‚Œã®ç’°å¢ƒã§å‹•ãã‚ˆã†ã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ã™ã€‚  
webpack ã¨åŒã˜ã‚‚ã®ã¨æ€ã£ã¦ãã ã•ã„ã€‚

### metro.config.js ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç§»å‹•

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒä½œæˆã—ãŸã‚‚ã®ã¯ mobile ç›´ä¸‹ã«ã„ã¾ã™ãŒã€metro ã‚‚ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæ§˜ã« hoisting ã•ã‚Œã¦ã„ã¾ã™ã€‚  
ãã®ãŸã‚ã€ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒˆã«ç§»å‹•ã—ã¾ã™ã€‚  
mobile ç›´ä¸‹ã«ã„ã¦ã‚‚ä¸€å¿œå‹•ã‹ã™ã“ã¨ã¯ã§ãã¾ã™ãŒã€ã“ã®è¨˜äº‹ã§æ›¸ã„ã¦ã‚‹è¨­å®šã¨ã¯ç•°ãªã£ã¦ãã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚  
ä¸»ã«ãƒ‘ã‚¹ã®å‚ç…§å…ˆãŒå¤‰ã‚ã‚Šã¾ã™ã€‚

### metro.config.js ã®ä¿®æ­£

metor ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ä»Šã¾ã§ã¨ã¯é€†ã§ã€ãƒ«ãƒ¼ãƒˆã«ã„ã‚‹ãŸã‚ã€ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆãŒè¦‹ã¤ã‘ã‚‰ã‚Œãªããªã£ã¦ã„ã¾ã™ã€‚  
ä¿®æ­£ã™ã‚‹ç®‡æ‰€ãŒå¤šã„ã®ã§ã€ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ã€‚  
å„è¨­å®šãŒä½•ã‚’ã—ã¦ã„ã‚‹ã‹ã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚  
ä½•ã‚’ã‚„ã£ã¦ã‚‹ã®ã‹ã¯ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãŸã ã‘ã§ã¯å…¨ç„¶ã‚ã‹ã‚‰ãªã„ï¼ˆç‰¹ã« Android ã®ç”»åƒå‘¨ã‚Šï¼‰ã®ã§ã€ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã”ã¨æŒã£ã¦ãã¦ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```js:packages/mobile/metro.config.js
const path = require('path');

const exclusionList = require('metro-config/src/defaults/exclusionList');

/**
 * metroãŒç›£è¦–ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸€è¦§
 * æŒ‡å®šã—ãŸãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒå…¥ã‚‹ã¨ã€ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
 */
const watchFolders = [
  path.resolve(__dirname, 'node_modules'),
];

/**
 * metroãŒç›£è¦–ã—ãªã„ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸€è¦§
 * æŒ‡å®šã—ãŸãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒå…¥ã£ã¦ã‚‚ã€ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªããªã‚‹
 * ãƒ¢ãƒãƒ¬ãƒã§ã¯è¨­å®šã—ãªã„ã¨ã€ç›£è¦–å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤šããªã‚Šã€ã¨ã¦ã‚‚é‡ããªã‚‹
 */
const blockList = exclusionList([
  /packages\web/,
  /node_modules\/@monorepo\/web/,
]);

module.exports = {
  projectRoot: path.join(__dirname, 'packages/mobile'),
  transformer: {
    /**
     * ãƒ¢ãƒãƒ¬ãƒã§AndroidãŒé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®è¨­å®š
     * Androidã®ç”»åƒã®ãƒ›ã‚¹ãƒˆå…ˆ
     */
    publicPath: '/assets/dark/magic',
    getTransformOptions: async () => ({
      transform: {
        experimentalImportSupport: false,
        inlineRequires: false,
      },
    }),
  },
  resolver: {
    resolverMainFields: ['react-native', 'browser', 'module', 'main'],
    blockList,
  },
  watchFolders,
  /**
   * ãƒ¢ãƒãƒ¬ãƒã§AndroidãŒé™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®è¨­å®š
   * metroã¯nodeã‚µãƒ¼ãƒã‚’èµ·å‹•ã—ã¦ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å‹•ã‹ã—ã¦ã„ã‚‹
   * ç”»åƒã®ãƒ›ã‚¹ãƒˆå…ˆã‚’å¤‰æ›´ã—ã€ç‰¹å®šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã§èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹
   * assets/dark/magicã¯metroãŒAndroidã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹æ™‚ã®ç”»åƒã®å‡ºåŠ›å…ˆã«ãªã£ã¦ã„ã‚‹
   */
  server: {
    enhanceMiddleware: (middleware) => {
      return (req, res, next) => {
        if (req.url.startsWith('/assets/dark/magic')) {
          req.url = req.url.replace('/assets/dark/magic', '/assets');
        } else if (req.url.startsWith('/assets/dark')) {
          req.url = req.url.replace('/assets/dark', '/assets/..');
        } else if (req.url.startsWith('/assets')) {
          req.url = req.url.replace('/assets', '/assets/../..');
        }
        return middleware(req, res, next);
      };
    },
  },
};
```

#### Android ã®ç”»åƒã«ã¤ã„ã¦

ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚‚æ›¸ã„ã¦ã„ã¾ã™ãŒã€assets/dark/magic ã¨ã„ã†é­”æ³•ã®ã‚ˆã†ãªå‘ªæ–‡ã¯ã€Android ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ãã®ç†ç”±ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
ã“ã“ã¾ã§ã®è¨­å®šã§ãƒ“ãƒ«ãƒ‰ã¯ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ï¼ˆã¨ã¯æ€ã†ï¼‰ã®ã§ã€ãƒ“ãƒ«ãƒ‰ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚  
å®Ÿè¡ŒãŒå®Œäº†ã™ã‚‹ã¨ã€android/app/src/main/res é…ä¸‹ã«ã„ãã¤ã‹ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚  
ãã®ä¸­ã«ã€`dark`ã¨`magic`ã¨ã„ã†å˜èªã‚’å«ã‚€ç”»åƒãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
yarn react-native bundle \
  --platform android \
  --dev false \
  --entry-file index.js \
  --bundle-output android/app/src/main/index.android.bundle \
  --assets-dest android/app/src/main/res
```

ã“ã‚“ãªæ„Ÿã˜ã«ç”»åƒãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚  
ç­†è€…ã¯ Java ã«ã¯è©³ã—ãã¯ãªã„ã§ã™ãŒã€ã“ã®\_ã¯ãŠãã‚‰ããƒ•ã‚¡ã‚¤ãƒ«ã®éšå±¤ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

![ReactNativeã®ãƒ­ã‚´ã®ãƒ•ã‚¡ã‚¤ãƒ«åãŒdark_magicã‹ã‚‰å§‹ã¾ã£ã¦ã„ã‚‹](https://storage.googleapis.com/zenn-user-upload/d1e6d1f84ea3-20230215.png)

## modules ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆ

ã“ã‚Œã§ç„¡äº‹ iOS ã¨ Android ãŒèµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚  
æœ€å¾Œã« web ã¨ mobile ã§ä½¿ã„å›ã™å…±é€šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚  
packages é…ä¸‹ã« modules ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã£ã¦ npm init ã‚’ã—ã¾ã—ã‚‡ã†ã€‚  
name ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯`@monorepo/modules`ã¨ã—ã¦ãŠãã€main ã«`src`ã‚’æŒ‡å®šã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```json: packages/modules/package.json
{
  "name": "@monorepo/modules",
  "version": "0.0.1",
  "description": "",
  "main": "src",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
```

src ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯ã‚«ãƒ©ãƒ¼ã®å®šæ•°ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ä½œã£ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```ts: packages/modules/src/colors.ts
export const BLACK = "#000000";
export const WHITE = "#FFFFFF";
```

```ts: packages/modules/src/index.ts
export * from './colors.ts'
```

### web ã§ modules ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹

React ã‚¢ãƒ—ãƒªã® web ã§èª­ã¿è¾¼ã‚€æ‰‹é †ã¯é€šå¸¸ã®ãƒ¢ãƒãƒ¬ãƒã¨å¤‰ã‚ã‚Šã‚ã‚Šã¾ã›ã‚“ã€‚

```diff json: packages/web/package.json
"dependencies": {
+  "@monorepo/modules": "*",
  "react": "17.0.1",
  "react-native": "0.64.1"
},
```

:::message
ã“ã®è¨˜äº‹ã§ã¯ yarn v1 ã‚’å‰æã«æ›¸ã„ã¦ã„ã¾ã™ã€‚  
yarn v2 ä»¥é™ã® Berry ã‚’ä½¿ã£ã¦ç’°å¢ƒæ§‹ç¯‰ã—ã¦ã„ã‚‹å ´åˆã€`*`ã§ã¯ãªã`workspace:*`ã¨æŒ‡å®šã—ã¦ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã€€
:::

### mobile ã§ modules ã‚’èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹

React Native ã‚¢ãƒ—ãƒªã® mobile ã§ã¯é•ã£ãŸè¨­å®šãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚  
package.json ã¨ metro.config.js ã®ä¸¡æ–¹ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

package.json ã®å¤‰æ›´ã¯ web ã¨åŒã˜ã§ã€dependencies ã«è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚

```diff json: packages/mobile/package.json
"dependencies": {
+  "@monorepo/modules": "*",
  "react": "17.0.1",
  "react-native": "0.64.1"
},
```

ç¶šã„ã¦ metro.config.js ã«ã¯ watchFolders ã«ãƒ‘ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```diff js: metro.config.js
const watchFolders = [
+  path.resolve(__dirname, "./packages/modules"),
  path.resolve(__dirname, "node_modules"),
];
```

ä»¥ä¸Šã§è¨­å®šã¯çµ‚ã‚ã‚Šã«ãªã‚Šã¾ã™ã€‚  
ãªãŠã€metro.config.js è‡ªä½“ã‚’å¤‰æ›´ã—ãŸæ™‚ã¯ã€ã‚µãƒ¼ãƒã‚’å†èµ·å‹•ã—ãªã„ã¨çµæœãŒåæ˜ ã•ã‚Œãªã„ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

èª­ã¿è¾¼ã‚€æ™‚ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‘ã°å¤§ä¸ˆå¤«ã§ã™ã€‚  
ã“ã‚Œã¯æ™®é€šã®ãƒ¢ãƒãƒ¬ãƒã¨åŒã˜ã ã—ã€web ã¨ mobile ã¨ã‚‚å…±é€šã§ã™ã€‚

```ts
import { BLACK, WHITE } from "@monorepo/modules";

// { BLACK: "#000000", WHITE: "#FFFFFF" }
console.log({ BLACK, WHITE });
```

## React ã¨ React Native ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šã™ã‚‹

æœ€å¾Œã« hoisting ãŒæ¥µåŠ›å´©ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€å¿…ãšæŒ‡å®šã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå…¥ã‚‹ã‚ˆã†ã«å›ºå®šã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚  
yarn ã«ã¯ resolutions ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã€å¿…ãšæŒ‡å®šã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã‚ˆã†ã«å¼·åˆ¶ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚  
ãªãŠã€ç¾åœ¨æœ€æ–°ã® npm v9.4.2 æ™‚ç‚¹ã§ã¯ã€resolutions æ©Ÿèƒ½ã¯æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚  
ã§ã™ãŒã€[npm-force-resolutions](https://github.com/rogeriochaves/npm-force-resolutions)ã¨ã„ã†ã‚‚ã®ãŒã‚ã‚Šã€ã“ã¡ã‚‰ã§åŒã˜ã“ã¨ãŒã§ãã¾ã™ã€‚

```diff json: package.json
{
  "name": "monorepo",
  "version": "0.0.1",
  "license": "ISC",
  "description": "",
  "private": true,
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "workspaces": ["packages/*"],
+  "resolutions": {
+    "react": "18.2.0",
+    "react-dom": "18.2.0",
+    "react-native": "0.71.0"
+  },
  "devDependencies": {
    "@typescript-eslint/eslint-plugin": "^5.51.0",
    "@typescript-eslint/parser": "^5.51.0",
    "eslint": "^8.34.0",
    "eslint-config-prettier": "^8.6.0",
    "eslint-plugin-react": "^7.32.2",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-native": "^4.0.0",
    "prettier": "^2.8.4",
    "typescript": "^4.9.5"
  }
}
```

# çµ‚ã‚ã‚Šã«

ãƒ¢ãƒãƒ¬ãƒã§ã‹ã¤ hoisting ã•ã›ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ React Native ã‚’ä½¿ãŠã†ã¨ã™ã‚‹ã¨ã€æœ€åˆã®ç’°å¢ƒæ§‹ç¯‰ã§ã‚„ã‚‹ã“ã¨ãŒã¨ã¦ã‚‚å¤šã„ã§ã™ã€‚  
ã¾ãŸã€é–‹ç™ºã‚’é€²ã‚ã¦ã„ãã†ã¡ã«ä¾å­˜é–¢ä¿‚ãŒå£Šã‚Œã¦ hoisting ã•ã‚Œãªããªã£ã¦å‹•ã‹ãªããªã‚‹ã“ã¨ã‚‚èµ·ã“ã£ãŸã‚Šã™ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚  
ã“ã®è¨˜äº‹ã§ã¯ã‚„ã‚Šæ–¹ã‚’ç´¹ä»‹ã—ã¾ã—ãŸãŒã€React Native ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã ã‘ã‚ã‚‹ã„ã¯ React Native ç³»ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã ã‘ noHoist ã«ã™ã‚‹ã¨ã„ã†ã“ã¨ã‚‚æ¤œè¨ã—ã¦ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ãƒ»ãƒ»ãƒ»ã‚‚ã—ã‹ã—ãŸã‚‰ãã£ã¡ã®æ–¹ãŒå¹¸ã›ãªã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚
